---
title: "Golem Package"
author: "RAMMSTEIN"
date: "9/10/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE, eval = FALSE)
```

## Installing {golem}

+ You can install the stable version of `{golem}` from CRAN:

```{r echo=TRUE}

install.packages("golem")

```

## Getting started 

Note before using `{golem}`: 

- A `{golem}` app is contained inside a package, so knowing how to build a package is highly recommended. On the plus side, everything you know about package development can be reused in `{golem}`.

- A `{golem}` app works better if you are working with `shiny modules`, so knowing how modules work is recommended, but not mandatory. 

In the rest of the Vignettes, we'll assume you're working in RStudio. 

### Create a package

Once the package is installed, you can got to File > New Project... in RStudio, and choose "Package for Shiny App Using golem" input. 

If you want to do it through command line, you can use:

```{r eval=FALSE, include=FALSE}

golem::create_golem(path = "path/to/package")

```

```{r include = FALSE, eval = TRUE, error = TRUE}

x <- fs::path(tempdir(), "mygolem")
try(fs::dir_delete(x), silent = TRUE)
golem::create_golem(path = x, package_name = "mygolem", open = FALSE)

```

If you're already familiar with R packages, most of these files will seem very familiar to you. That's because a `{golem}` app IS a package.

+ `DESCRIPTION` & `NAMESPACE`: Package meta-data.

+ `R/app_config.R`: Used to read inside `{golem}` config file located at `inst/golem-config.yml`.

+ `R/app_server.R`, `R/app_ui.R`: Top level UI and server elements. 

+ `R/run_app.R`: a function to configure and launch the application.

+ `dev/`: Scripts that will be used along the process of developing your app. You don't need to fill all the script before starting: use them as a notebook for keeping track of what you're doing all along the project life.

+ `inst/app/www`: Where you will add external dependencies in `www` (images, css, etc), notably added with the `golem` functions used to create external resources. 

+ `man`: Package documentation, to be generated by R & `{roxygen2}`.  

# `dev/01_start.R`

Once you've created your project, the first file that opens is `dev/01_start.R`. This file contains a series of commands that you'll have to run once, at the beginning of the project. 

Note that you don't have to fill everything, event thought it's strongly recommended.

### Fill the DESCRIPTION

First, fill the DESCRIPTION by adding information about the package that will contain your app. The first function, `fill_desc()`, can be used to fill your `DESCRIPTION` file.

```{r eval=FALSE, include=FALSE}

golem::fill_desc(
  pkg_name = "mygolem", # The Name of the package containing the App 
  pkg_title = "PKG_TITLE", # The Title of the package containing the App 
  pkg_description = "PKG_DESC.", # The Description of the package containing the App 
  author_first_name = "AUTHOR_FIRST", # Your First Name
  author_last_name = "AUTHOR_LAST",  # Your Last Name
  author_email = "AUTHOR@MAIL.COM",      # Your Email
  repo_url = NULL # The (optional) URL of the GitHub Repo
) 

```

About [the DESCRIPTION file](https://r-pkgs.org/description.html).

### Add `{golem}` options

Please DO run this line of code, as it sets a series of global options inside `golem-config.yml` that will be reused inside `{golem}`.

```{ eval=FALSE, include=FALSE}

golem::set_golem_options()

```

### Set common Files 

If you want to use the MIT license, README, code of conduct, lifecycle badge, a news file, etc.

```{r eval = FALSE}

## See ?usethis for more information
usethis::use_mit_license( name = "Golem User" )  # You can set another license here
usethis::use_readme_rmd( open = FALSE )
usethis::use_code_of_conduct()
usethis::use_lifecycle_badge( "Experimental" )
usethis::use_news_md( open = FALSE )

```

See [`{usethis}`](https://usethis.r-lib.org/) for more info about these functions.

### Init Tests

Create a template for tests:

```{r eval=FALSE, include=FALSE}

golem::use_recommended_tests()

```

About [tests in a package](https://r-pkgs.org/tests.html).

### Use Recommended Packages

This will add "shiny", "DT", "attempt", "glue", "htmltools", and "golem" as a dependency to your package.

```{r eval=FALSE, include=FALSE}

golem::use_recommended_deps()

```

### Add various tools

+ If you want to change the default favicon

```{r eval=FALSE, include=FALSE}

# Remove current favicon
golem::remove_favicon()
# Add a new one
golem::use_favicon( path = "path/to/favicon")

```

Note that you can add an url, and the favicon will be downloaded to the `inst/app/www` folder. 

> **Note**: If you are deploying your app with [ShinyProxy](https://www.shinyproxy.io/), your favicon should have the `.png` extension, otherwise it is not going to work.
+ Utils

These two functions add a file with various functions that can be used along the process of building your app.

See each file in details for a description of the functions.

```{r eval=FALSE, include=FALSE}

golem::use_utils_ui()
golem::use_utils_server()

```

## Try the app

To run the app, go to the `dev/run_dev.R` file, and launch the all thing.

You're now set! You've successfully initiated the project and can go to dev/02_dev.R.

```{r eval=FALSE, include=FALSE}

rstudioapi::navigateToFile("dev/02_dev.R")

```

```{r eval = TRUE}

try(fs::dir_delete(x), silent = TRUE)

```



## Day to day development with `{golem}`

Now that you're all set with your project init, time to move to development!

App development should happen through the `dev/02_dev.R` file, which contains common commands for developing. 

## Launching the app

To run the app, go to the `dev/run_dev.R` file, and run the all thing.

# `dev/02_dev.R`

### Add dependencies

To be called each time you need a new package as a dependency:

```{r eval=FALSE, include=FALSE}

usethis::use_package("pkg")

```

About [package dependencies](https://r-pkgs.org/namespace.html).

### Add modules

The `golem::add_module()` functions creates a module in the `R` folder. The file and the modules will be named after the `name` parameter, by adding `mod_` to the R file, and `mod_*_ui` and `mod_*_server` to the UI and server functions.

```{r eval=FALSE, include=FALSE}

golem::add_module( name = "my_first_module" ) # Name of the module

```

The new file will contain:

```{r}

# mod_UI
mod_my_first_module_ui <- function(id){
  ns <- NS(id)
  tagList(
  
  )
}
mod_my_first_module_server <- function(input, output, session){
  ns <- session$ns
}
    
## To be copied in the UI
# mod_my_first_module_ui("my_first_module_1")
    
## To be copied in the server
# callModule(mod_my_first_module_server, "my_first_module_1")

```

At the end of the file, you will find a piece of code that has to be copied and pasted inside your UI and server functions.

## Add function files 

```{r eval=FALSE, include=FALSE}

golem::add_fct( "helpers" ) 
golem::add_utils( "helpers" )

```

These two function create `R/fct_helpers.R` and `R/utils_helpers.R`, two file you can use to add business logic functions.

### Add external files

These functions create external dependencies (JavaScript and CSS). `add_js_file()` creates a simple JavaScript file, while `add_js_handler()` adds a file with a skeleton for shiny custom handlers.

```{r eval=FALSE, include=FALSE}

golem::add_js_file("script")
golem::add_js_handler("script")
golem::add_css_file("custom")

```

Note: While the general philosophy of `{golem}` is being based on the idea that you're building a package, these functions can be used outside of a `{golem}` project. 

Note that you can also download external CSS and JavaScript files with:

```{r eval=FALSE, include=FALSE}

golem::use_external_css_file(url = "url", name = "your_provided_name")
golem::use_external_js_file(url = "url", name = "your_provided_name")

```
The above has the effect of downloading the file at the specified url and giving it a provided name. If the intent is to use a CDN hosted CSS/JS file then manually add the tag - `tags$script(src = "source_of_ur_css/js")` in the function `golem_add_external_resources` in file `app-ui.R`. The tag can be added inside the `tags$head(...)` if the intent is to load the  js/css file in the `<head>` of the document or outside it if it is intended in the `<body>`.

### Adding these external resources to your app

You can add any external resource into `inst/app/www`. 

JavaScript and CSS are automatically linked in the `golem_add_external_resources()` function. If you add other resources (example images), you can link them in the app with the `www` prefix: 

```{r eval=FALSE, include=FALSE}

tags$img(src = "www/my.png")

```

You can also list here the use of other packages, for example `useShinyalert()` from the `{shinyalert}` package.

### Add a data-raw folder

If you have data in your package: 

```{r eval=FALSE, include=FALSE}

usethis::use_data_raw()

```

About [data in a package](https://r-pkgs.org/data.html).

### Add tests

Add more tests to your application:

```{r eval=FALSE, include=FALSE}

usethis::use_test( "app" )

```

About [testing a package](https://r-pkgs.org/tests.html).

## Documentation

### Vignette

```{r eval=FALSE, include=FALSE}
usethis::use_vignette("shinyexample")
devtools::build_vignettes()
```

About [package Vignette](https://r-pkgs.org/vignettes.html).

### Code coverage

```{r}

usethis::use_travis()
usethis::use_appveyor()
usethis::use_coverage()

```

## Using `{golem}` dev functions

There's a series of tools to make your app behave differently whether it's in dev or prod mode. Notably, the `app_prod()` and `app_dev()` function tests for `options( "golem.app.prod")` (or return TRUE if this option doesn't exist). 

Setting this options at the beginning of your dev process allows to make your app behave in a specific way when you are in dev mode. For example, printing message to the console with `cat_dev()`.

```{r eval = TRUE}

options( "golem.app.prod" = TRUE)
golem::cat_dev("hey\n")
options( "golem.app.prod" = FALSE)
golem::cat_dev("hey\n")

```

You can then make any function being "dev-dependent" with the `make_dev()` function: 

```{r eval = TRUE}

log_dev <- golem::make_dev(log)
log_dev(10)
options( "golem.app.prod" = TRUE)
log_dev(10)

```


## About the `run_app()` function

When launching the app, you might have noticed that the `dev/run_dev.R` function calls `run_app()`, which has the following structure:

```{r}

run_app <- function(
  ...
) {
  with_golem_options(
    app = shinyApp(
      ui = app_ui, 
      server = app_server
    ), 
    golem_opts = list(...)
  )
}

```

This function might looks a little bit weird, but there's a long story behind it, and you can read more about it [there](https://rtask.thinkr.fr/blog/shinyapp-runapp-shinyappdir-difference/).

But long story short, this combination of `with_golem_options` & `golem_opts = list(...)` allows you to pass argument to the function to be used inside the application, from UI or from server side, which you can get with `get_golem_options()`.

```{r}

run_app(this = "that")
# And in the app 
this <- get_golem_options("this")

```

The idea is to provide more flexibility for deployment on each platform you want to run your app on.

# Deploying Apps with `{golem}`

The `dev/03_deploy.R` file contains function for deploying on various platforms. 

### RStudio Products

```{r}

golem::add_rstudioconnect_file()
golem::add_shinyappsio_file()
golem::add_shinyserver_file()

```


### Docker 

```{r}

# If you want to deploy via a generic Dockerfile
golem::add_dockerfile()
# If you want to deploy to ShinyProxy
golem::add_dockerfile_shinyproxy()
# If you want to deploy to Heroku
golem::add_dockerfile_heroku()

```

